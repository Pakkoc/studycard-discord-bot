# 연간 잔디 색상 시스템 보고서

## 📊 개요

본 문서는 Discord 봇의 연간 활동 캘린더(잔디) 이미지에 적용되는 색상 시스템에 대한 상세 기술 보고서입니다.

---

## 🎨 월별 색상 체계

각 월마다 고유한 최대 색상(100% 강도)이 지정되어 있으며, 시간대별로 그라데이션이 적용됩니다.

### 월별 최대 색상 정의

| 월 | HEX 코드 | RGB 값 | 색상 설명 |
|---|---------|--------|----------|
| **1월** | `#ED018A` | `(237, 1, 138)` | 선명한 핑크 |
| **2월** | `#CF1A1B` | `(207, 26, 27)` | 진한 빨강 |
| **3월** | `#F06730` | `(240, 103, 48)` | 주황색 |
| **4월** | `#F08622` | `(240, 134, 34)` | 밝은 오렌지 |
| **5월** | `#E9EB28` | `(233, 235, 40)` | 밝은 노랑 |
| **6월** | `#B4E742` | `(180, 231, 66)` | 연두색 |
| **7월** | `#5FC650` | `(95, 198, 80)` | 초록색 |
| **8월** | `#1FA5A6` | `(31, 165, 166)` | 청록색 |
| **9월** | `#1B1AF1` | `(27, 26, 241)` | 선명한 파랑 |
| **10월** | `#4112A0` | `(65, 18, 160)` | 진한 보라 |
| **11월** | `#741DA0` | `(116, 29, 160)` | 자주색 |
| **12월** | `#B23593` | `(178, 53, 147)` | 핑크-퍼플 |

---

## 🎨 색상 팔레트 결정 (1-2-1안)

### 최종 결정 사항

여러 개선안(v1.1, v1.2, v1.3)을 검토한 결과, **원래의 1-2-1안**을 최종 색상 팔레트로 결정했습니다.

### 결정 이유

- **월별 색상의 다양성**: 12개월 각각 고유한 색상으로 월별 구분 가능
- **7단계 그라데이션**: 활동 시간에 따른 명확한 시각적 피드백 제공
- **심미적 완성도**: 계절의 흐름을 자연스럽게 표현
- **안정성**: 검증된 색상 조합으로 일관된 사용자 경험 제공

---

## 🌈 7단계 그라데이션 시스템

### 색상 강도 계산 방식

각 월의 최대 색상을 기준으로, 흰색(`#FFFFFF`)에서 최대 색상까지 7단계 그라데이션이 적용됩니다.

**그라데이션 공식:**
```
R = 255 + (base_R - 255) × 강도
G = 255 + (base_G - 255) × 강도
B = 255 + (base_B - 255) × 강도
```

### 시간대별 강도 구간

| 단계 | 강도 | 시간 범위 | 설명 |
|-----|------|----------|------|
| **공백** | 0% | 0초 | 회색 `#E5E7EB` (접속 기록 없음) |
| **1단계** | 14.29% | 1초 ~ 1시간 43분 미만 | 0.0003시간 ~ 1.71시간 |
| **2단계** | 28.57% | 1시간 43분 ~ 3시간 26분 미만 | 1.71시간 ~ 3.43시간 |
| **3단계** | 42.86% | 3시간 26분 ~ 5시간 9분 미만 | 3.43시간 ~ 5.14시간 |
| **4단계** | 57.14% | 5시간 9분 ~ 6시간 52분 미만 | 5.14시간 ~ 6.86시간 |
| **5단계** | 71.43% | 6시간 52분 ~ 8시간 34분 미만 | 6.86시간 ~ 8.57시간 |
| **6단계** | 85.71% | 8시간 34분 ~ 12시간 미만 | 8.57시간 ~ 12.0시간 |
| **7단계** | 100% | 12시간 이상 | 12.0시간 이상 (최대 색상) |

### 강도별 시각적 효과

- **낮은 강도 (1~2단계)**: 거의 흰색에 가까운 매우 연한 색상
- **중간 강도 (3~5단계)**: 색상이 점차 진해지며 활동량이 증가함을 표시
- **높은 강도 (6~7단계)**: 선명하고 진한 색상으로 높은 활동량을 강조

---

## ⏰ 집계 시간 기준

### 일일 경계 시간 (Day Boundary)

**기준 시간: 한국 표준시(KST) 오전 06:00**

- 하루의 시작: 매일 오전 06:00 (KST)
- 하루의 종료: 다음날 오전 05:59:59 (KST)

### 시간대 처리 방식

1. **UTC 기준 저장**: 모든 세션 시간은 UTC로 데이터베이스에 저장됩니다.
2. **KST 변환**: 집계 시 `Asia/Seoul` 타임존으로 변환됩니다.
3. **6시간 시프트**: KST 시간에서 6시간을 뺀 후 날짜를 산출합니다.

### 예시

```
사용자 A의 음성 채널 접속 시간:
- 2025년 1월 15일 23:00 (KST) ~ 2025년 1월 16일 07:00 (KST)
- 총 8시간 접속

집계 결과:
- 2025-01-15: 7시간 (23:00 ~ 06:00)
- 2025-01-16: 1시간 (06:00 ~ 07:00)
```

### 코드 구현 위치

**Python (Discord Bot):**
```python
# core/database.py, line 322-326
# 하루 경계: KST 06:00 기준으로 스트릭 일자를 산출한다.
local = ended_at.astimezone(timezone(timedelta(hours=9)))
shifted = local - timedelta(hours=6)
streak_day: date = shifted.date()
```

**TypeScript (Dashboard):**
```typescript
// dashboard/lib/stats.ts, line 438-439
// KST 기준 06:00 경계 설정
(date_trunc('day', $3::timestamptz AT TIME ZONE 'Asia/Seoul') + interval '6 hour')
```

---

## 📐 기술적 세부사항

### 색상 계산 함수

**함수명:** `_intensity_color(hours: float, month: int)`

**위치:** `core/imaging.py` (line 793-822)

**동작 방식:**
1. 입력된 시간(hours)이 0 이하인 경우 → 회색 반환
2. 해당 월(month)의 최대 색상 조회
3. 시간에 따른 강도(t) 계산 (7단계 구간)
4. 흰색에서 최대 색상으로 선형 보간하여 최종 색상 반환

### 세션 분할 로직

**여러 날에 걸친 세션 처리:**

음성 채널 세션이 06:00 경계를 넘어가는 경우, 자동으로 날짜별로 분할됩니다.

```sql
-- SQL 쿼리 예시 (core/database.py, line 524-544)
generate_series(
  (date_trunc('day', start_kst - interval '6 hour') + interval '6 hour'),
  (date_trunc('day', end_kst - interval '6 hour') + interval '6 hour'),
  interval '1 day'
) AS date_boundary
```

---

## 🎯 사용 사례

### Discord 명령어

- `/잔디` - 개인 연간 활동 캘린더 조회
- `/잔디 @사용자` - 특정 사용자의 연간 활동 캘린더 조회

### 대시보드

- 웹 대시보드에서 사용자별 연간 활동 히트맵 표시
- 월별 색상 구분으로 시각적 가독성 향상

---

## 📝 참고사항

### 공백 셀 (회색)

- **색상:** `#E5E7EB` (연한 회색)
- **의미:** 해당 날짜에 음성 채널 접속 기록이 전혀 없음
- **시간:** 정확히 0초

### 최소 활동 (1단계)

- **시작 시간:** 1초 (0.0003시간)
- **의미:** 매우 짧은 시간이라도 접속 기록이 있으면 색상 표시
- **강도:** 14.29% (거의 흰색에 가까운 연한 색상)

### 최대 활동 (7단계)

- **기준 시간:** 12시간 이상
- **의미:** 하루 중 절반 이상을 음성 채널에서 활동
- **강도:** 100% (해당 월의 최대 색상 그대로 표시)

---

## 🔧 유지보수 정보

### 색상 변경 방법

`core/imaging.py` 파일의 `month_colors` 딕셔너리를 수정합니다.

```python
# line 777-790 (1-2-1안 최종)
month_colors = {
    1: (237, 1, 138),     # #ED018A
    2: (207, 26, 27),     # #CF1A1B
    3: (240, 103, 48),    # #F06730
    4: (240, 134, 34),    # #F08622
    5: (233, 235, 40),    # #E9EB28
    6: (180, 231, 66),    # #B4E742
    7: (95, 198, 80),     # #5FC650
    8: (31, 165, 166),    # #1FA5A6
    9: (27, 26, 241),     # #1B1AF1
    10: (65, 18, 160),    # #4112A0
    11: (116, 29, 160),   # #741DA0
    12: (178, 53, 147),   # #B23593
}
```

### 시간 구간 변경 방법

`_intensity_color` 함수 내부의 조건문을 수정합니다.

```python
# line 803-816
if hours >= 12.0:
    t = 1.0  # 7단계
elif hours >= 8.57:
    t = 0.8571  # 6단계
# ... (나머지 구간)
```

### 일일 경계 시간 변경 방법

현재 06:00 기준을 변경하려면:
1. `core/database.py` - line 325의 `timedelta(hours=6)` 수정
2. `dashboard/lib/stats.ts` - SQL 쿼리의 `interval '6 hour'` 수정

---

## 📊 통계 정보

- **총 색상 팔레트:** 12개 (월별)
- **단계별 구간:** 8개 (공백 포함 7단계 + 공백)
- **시간 집계 기준:** KST 06:00 경계
- **최소 표시 시간:** 1초 (0.0003시간)
- **최대 강도 기준:** 12시간

---

## 📋 변경 이력

### 최종 (2025-11-10) - 1-2-1안 확정
- **최종 결정**: 원래의 1-2-1안을 최종 색상 팔레트로 확정
- 여러 개선안(v1.1, v1.2, v1.3) 검토 후 원안 채택
- 월별 색상의 다양성과 7단계 그라데이션 유지
- 안정적이고 검증된 색상 조합 선택

### v1.0 (2025-11-10)
- 초기 문서 작성
- 월별 색상 체계 정의 (1-2-1안)
- 7단계 그라데이션 시스템 설명
- 집계 시간 기준 문서화 (KST 06:00 경계)

---

**문서 버전:** 1.0 (최종)  
**최종 수정일:** 2025-11-10  
**작성자:** AI Assistant  
**관련 파일:** `core/imaging.py`, `core/database.py`, `dashboard/lib/stats.ts`

